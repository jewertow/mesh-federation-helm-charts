{{- if .Values.global.egressGateway.enabled }}
{{- $remotes := .Values.global.remote | default list }}
{{- if gt (len $remotes) 0 }}
{{- range $meshIdx, $mesh := $remotes }}
{{- $firstAddr := index $mesh.addresses 0 }}
{{- $isIPAddress := regexMatch "^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$" $firstAddr }}
{{- if and $.Values.global.enableGatewayAPI $isIPAddress }}
apiVersion: v1
kind: Service
metadata:
  name: ingress-{{ $mesh.mesh }}
  namespace: {{ $.Release.Namespace }}
spec:
  clusterIP: None
  ports:
  - port: {{ $mesh.port }}
    name: auto-passthrough-tls
    protocol: TCP
  selector: {}
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: ingress-{{ $mesh.mesh }}
  namespace: {{ $.Release.Namespace }}
  labels:
    kubernetes.io/service-name: ingress-{{ $mesh.mesh }}
addressType: IPv4
ports:
- name: auto-passthrough-tls
  port: {{ $mesh.port }}
  protocol: TCP
endpoints:
{{- range $addr := $mesh.addresses }}
- addresses:
  - {{ $addr }}
  zone: {{ $mesh.locality | default "unknown" }}
{{- end }}
---
{{- else }}
{{/* Create ServiceEntry when Gateway API is not enabled */}}
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: ingress-{{ $mesh.mesh }}
  namespace: {{ $.Release.Namespace }}
spec:
  exportTo:
  - "."
  hosts:
  - ingress.{{ $mesh.mesh }}.global
  ports:
  - number: {{ $mesh.port }}
    name: auto-passthrough-tls
    protocol: TLS
  resolution: DNS
  location: MESH_INTERNAL
  endpoints:
  {{- range $addr := $mesh.addresses }}
  - address: {{ $addr }}
    ports:
      auto-passthrough-tls: {{ $mesh.port }}
    network: {{ $mesh.network }}
    {{- if $mesh.locality }}
    locality: {{ $mesh.locality }}
    {{- end }}
  {{- end }}
---
{{- end }}
{{- end }}
{{- end }}
{{- end }}
